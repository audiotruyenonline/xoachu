<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tool c·∫Øt & l√†m s·∫°ch ch∆∞∆°ng truy·ªán</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121a2b;
      --panel2:#0f1728;
      --line:#23304a;
      --text:#e8eefc;
      --muted:#9fb0d4;
      --accent:#4ea1ff;
      --ok:#38d39f;
      --warn:#ffb84d;
      --err:#ff6b6b;
      --chip:#1b2740;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#09101d,#0c1424 35%, #0a1220);
      color:var(--text);
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
    }
    .header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      font-size:20px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size:13px;
      margin-top:2px;
    }
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:12px;
      border-bottom:1px solid var(--line);
      align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background:#16213a;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      transition:.15s ease;
    }
    .btn:hover{ transform:translateY(-1px); border-color:#315089; }
    .btn:active{ transform:translateY(0); }
    .btn.primary{ background:linear-gradient(180deg,#2f7be8,#235fba); border-color:#3b7fe0; }
    .btn.success{ background:linear-gradient(180deg,#1e7c62,#16624f); border-color:#279a7b; }
    .btn.warn{ background:linear-gradient(180deg,#8d6120,#6f4b16); border-color:#b37b28; }
    .btn.ghost{ background:transparent; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .pill{
      margin-left:auto;
      color:var(--muted);
      font-size:12px;
      background:var(--chip);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      padding:12px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns:1fr; }
      .pill{ margin-left:0; }
    }
    .panel{
      display:flex;
      flex-direction:column;
      min-height:460px;
    }
    .panel h3{
      margin:0;
      padding:12px 12px 0;
      font-size:14px;
      color:#dbe8ff;
      font-weight:700;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      padding:4px 12px 10px;
    }
    textarea{
      width:100%;
      min-height:360px;
      resize:vertical;
      border:1px solid var(--line);
      background:#0b1322;
      color:var(--text);
      border-radius:12px;
      padding:12px;
      outline:none;
      line-height:1.55;
      font-size:14px;
      margin:0 12px 12px;
    }
    textarea:focus{ border-color:#3f76d7; box-shadow:0 0 0 3px rgba(78,161,255,.12); }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:0 12px 12px;
    }
    .row .btn{ padding:8px 10px; font-size:13px; }
    .status{
      margin:0 12px 12px;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:#101a2d;
      color:var(--muted);
      font-size:13px;
      min-height:40px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .status.ok{ color:#b9ffe7; border-color:rgba(56,211,159,.35); background:rgba(56,211,159,.08); }
    .status.err{ color:#ffd1d1; border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.08); }
    .status.warn{ color:#ffe8c1; border-color:rgba(255,184,77,.35); background:rgba(255,184,77,.08); }
    .footer{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      padding:10px 12px 14px;
      border-top:1px dashed var(--line);
    }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    input[type="file"]{
      display:none;
    }
    .stats{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      color:var(--muted);
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
    }
    .drop{
      margin:0 12px 12px;
      border:1px dashed #34528b;
      border-radius:12px;
      padding:12px;
      text-align:center;
      color:var(--muted);
      background:rgba(78,161,255,.05);
      font-size:13px;
    }
    .drop.drag{
      border-color:#67b4ff;
      background:rgba(78,161,255,.12);
      color:#d8ecff;
    }
    .kbd{
      border:1px solid var(--line);
      padding:1px 6px;
      border-radius:6px;
      background:#0e1729;
      font-size:11px;
      color:#c9daff;
    }
    details{
      margin:12px;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#0f1728;
    }
    details > summary{
      cursor:pointer;
      padding:10px 12px;
      color:#dbe8ff;
      font-weight:600;
      user-select:none;
      list-style:none;
    }
    details > summary::-webkit-details-marker{ display:none; }
    .detailsBody{
      border-top:1px solid var(--line);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .detailsBody textarea{
      min-height:88px;
      margin:0;
      resize:vertical;
    }
    .field{
      display:grid;
      gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    .field input,
    .field textarea{
      width:100%;
      border:1px solid var(--line);
      background:#0b1322;
      color:var(--text);
      border-radius:10px;
      padding:10px;
      outline:none;
      font-size:14px;
    }
    .field textarea{
      min-height:88px;
      resize:vertical;
      margin:0;
      line-height:1.45;
    }
    .field input:focus,
    .field textarea:focus{
      border-color:#3f76d7;
      box-shadow:0 0 0 3px rgba(78,161,255,.12);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">Tool c·∫Øt & l√†m s·∫°ch ch∆∞∆°ng truy·ªán</div>
        <div class="subtitle">T·ª± l·∫•y ƒëo·∫°n n·ªôi dung t·ª´ <span class="mono">@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng</span> ƒë·∫øn tr∆∞·ªõc <span class="mono">Ch∆∞∆°ng tr∆∞·ªõc</span></div>
      </div>
      <div class="stats">
        <div class="chip" id="statInput">Input: 0 k√Ω t·ª±</div>
        <div class="chip" id="statOutput">Output: 0 k√Ω t·ª±</div>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <button class="btn primary" id="btnExtract">L·∫•y ƒëo·∫°n truy·ªán</button>
        <button class="btn success" id="btnOneClick">L√†m s·∫°ch 1 ch·∫°m</button>
        <button class="btn" id="btnCopy">Copy k·∫øt qu·∫£</button>
        <button class="btn warn" id="btnDownloadTxt">T·∫£i TXT</button>
        <button class="btn ghost" id="btnSwap">ƒê∆∞a k·∫øt qu·∫£ l√™n √¥ tr√™n</button>
        <button class="btn ghost" id="btnClearAll">X√≥a t·∫•t c·∫£</button>

        <label class="btn" for="fileInput">M·ªü file .txt</label>
        <input id="fileInput" type="file" accept=".txt,text/plain">

        <span class="pill">M·∫πo: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> = L·∫•y ƒëo·∫°n</span>
      </div>

      <details>
        <summary>‚öôÔ∏è T√πy ch·ªânh m·ªëc c·∫Øt (n·∫øu web ngu·ªìn ƒë·ªïi m·ªëc)</summary>
        <div class="detailsBody">
          <div class="field">
            <label for="startMarker">M·ªëc b·∫Øt ƒë·∫ßu (n·ªôi dung s·∫Ω l·∫•y SAU m·ªëc n√†y)</label>
            <input id="startMarker" value="@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng" />
          </div>
          <div class="field">
            <label for="endMarker">M·ªëc k·∫øt th√∫c m·∫∑c ƒë·ªãnh (fallback n·∫øu danh s√°ch ∆∞u ti√™n b√™n d∆∞·ªõi tr·ªëng)</label>
            <input id="endMarker" value="Ch∆∞∆°ng tr∆∞·ªõc" />
          </div>
          <div class="field">
            <label for="endMarkersPriority">M·ªëc k·∫øt th√∫c theo th·ª© t·ª± ∆∞u ti√™n (m·ªói d√≤ng 1 m·ªëc) ‚Äî v√≠ d·ª•: c√≥ "Ch∆∞∆°ng tr∆∞·ªõc" th√¨ d√πng ngay, n·∫øu kh√¥ng c√≥ m·ªõi x√©t "M·ª•c l·ª•c"</label>
            <textarea id="endMarkersPriority" placeholder="M·ªói d√≤ng 1 m·ªëc k·∫øt th√∫c, x√©t theo th·ª© t·ª±">Ch∆∞∆°ng tr∆∞·ªõc
M·ª•c l·ª•c
Ch∆∞∆°ng sau</textarea>
          </div>
          <div class="field">
            <label for="extraRemovePhrases">C·ª•m t·ª´ x√≥a th√™m (m·ªói d√≤ng 1 c·ª•m) ‚Äî v√≠ d·ª•: Ch∆∞∆°ng tr∆∞·ªõc, M·ª•c l·ª•c, Ch∆∞∆°ng sau</label>
            <textarea id="extraRemovePhrases" placeholder="M·ªói d√≤ng 1 c·ª•m t·ª´ c·∫ßn x√≥a">Ch∆∞∆°ng tr∆∞·ªõc
M·ª•c l·ª•c
Ch∆∞∆°ng sau</textarea>
          </div>
        </div>
      </details>

      <div class="grid">
        <div class="panel">
          <h3>VƒÉn b·∫£n g·ªëc (d√°n v√†o ƒë√¢y)</h3>
          <div class="hint">D√°n to√†n b·ªô n·ªôi dung copy t·ª´ web. Tool s·∫Ω t·ª± c·∫Øt ph·∫ßn truy·ªán theo 2 m·ªëc c·ªë ƒë·ªãnh.</div>
          <div class="drop" id="dropZone">K√©o th·∫£ file <b>.txt</b> v√†o ƒë√¢y (ho·∫∑c b·∫•m ‚ÄúM·ªü file .txt‚Äù)</div>
          <textarea id="inputText" placeholder="D√°n vƒÉn b·∫£n v√†o ƒë√¢y..."></textarea>
          <div class="row">
            <button class="btn" id="btnPaste">D√°n t·ª´ clipboard</button>
            <button class="btn" id="btnTrimInput">X√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi</button>
            <button class="btn" id="btnNormalize">Chu·∫©n h√≥a xu·ªëng d√≤ng</button>
          </div>
        </div>

        <div class="panel">
          <h3>K·∫øt qu·∫£ (ƒëo·∫°n truy·ªán ƒë√£ c·∫Øt)</h3>
          <div class="hint">K·∫øt qu·∫£ sau khi c·∫Øt (v√† l√†m s·∫°ch n·∫øu d√πng n√∫t ‚ÄúL√†m s·∫°ch 1 ch·∫°m‚Äù).</div>
          <textarea id="outputText" placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y..." readonly></textarea>
          <div class="row">
            <button class="btn" id="btnSelectOutput">Ch·ªçn to√†n b·ªô k·∫øt qu·∫£</button>
            <button class="btn" id="btnRemoveBlankLines">G·ªôp d√≤ng tr·ªëng d∆∞</button>
            <button class="btn" id="btnRemoveWatermark">X√≥a watermark ph·ªï bi·∫øn</button>
          </div>
        </div>
      </div>

      <div id="status" class="status">S·∫µn s√†ng. D√°n vƒÉn b·∫£n v√†o √¥ b√™n tr√°i r·ªìi b·∫•m <b>L·∫•y ƒëo·∫°n truy·ªán</b> ho·∫∑c <b>L√†m s·∫°ch 1 ch·∫°m</b>.</div>

      <div class="footer">
        <div>‚úÖ Ch·∫°y offline ƒë∆∞·ª£c ‚Ä¢ ‚úÖ D√πng ƒë∆∞·ª£c tr√™n GitHub Pages ‚Ä¢ ‚úÖ Kh√¥ng c·∫ßn server</div>
        <div class="mono">v3.0 - priority end markers</div>
      </div>
    </div>
  </div>

  <script>
    const els = {
      input: document.getElementById('inputText'),
      output: document.getElementById('outputText'),
      status: document.getElementById('status'),
      statInput: document.getElementById('statInput'),
      statOutput: document.getElementById('statOutput'),
      startMarker: document.getElementById('startMarker'),
      endMarker: document.getElementById('endMarker'),
      endMarkersPriority: document.getElementById('endMarkersPriority'),
      extraRemovePhrases: document.getElementById('extraRemovePhrases'),
      fileInput: document.getElementById('fileInput'),
      dropZone: document.getElementById('dropZone'),
      btnExtract: document.getElementById('btnExtract'),
      btnOneClick: document.getElementById('btnOneClick'),
      btnCopy: document.getElementById('btnCopy'),
      btnDownloadTxt: document.getElementById('btnDownloadTxt'),
      btnSwap: document.getElementById('btnSwap'),
      btnClearAll: document.getElementById('btnClearAll'),
      btnPaste: document.getElementById('btnPaste'),
      btnTrimInput: document.getElementById('btnTrimInput'),
      btnNormalize: document.getElementById('btnNormalize'),
      btnSelectOutput: document.getElementById('btnSelectOutput'),
      btnRemoveBlankLines: document.getElementById('btnRemoveBlankLines'),
      btnRemoveWatermark: document.getElementById('btnRemoveWatermark')
    };

    function setStatus(msg, type=''){
      els.status.className = 'status' + (type ? ' ' + type : '');
      els.status.innerHTML = msg;
    }

    function normalizeNewlines(text){
      return String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    }

    function updateStats(){
      const i = els.input.value.length;
      const o = els.output.value.length;
      els.statInput.textContent = `Input: ${i.toLocaleString('vi-VN')} k√Ω t·ª±`;
      els.statOutput.textContent = `Output: ${o.toLocaleString('vi-VN')} k√Ω t·ª±`;
    }

    function escapeRegExp(str){
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function getEndMarkerPriorityList(){
      const raw = (els.endMarkersPriority && els.endMarkersPriority.value) ? els.endMarkersPriority.value : '';
      return normalizeNewlines(raw)
        .split('\n')
        .map(s => s.trim())
        .filter(Boolean);
    }

    function findEndMatchByPriority(afterStart, endMarker, endMarkersPriority){
      const priorityList = Array.isArray(endMarkersPriority) ? endMarkersPriority.map(s => String(s || '').trim()).filter(Boolean) : [];
      const candidates = priorityList.length ? priorityList : [String(endMarker || 'Ch∆∞∆°ng tr∆∞·ªõc').trim()].filter(Boolean);

      for (const marker of candidates) {
        let endRegex;
        if (marker.toLowerCase() === 'ch∆∞∆°ng tr∆∞·ªõc') {
          endRegex = /Ch∆∞∆°ng tr∆∞·ªõc/i;
        } else {
          endRegex = new RegExp(escapeRegExp(marker), 'i');
        }
        const endMatch = endRegex.exec(afterStart);
        if (endMatch) {
          return { match: endMatch, marker };
        }
      }

      return null;
    }

    function extractStoryContentRobust(rawText, startMarker, endMarker, endMarkersPriority){
      if (!rawText || typeof rawText !== 'string') {
        return { ok:false, error:'Kh√¥ng c√≥ d·ªØ li·ªáu vƒÉn b·∫£n.' };
      }

      const text = normalizeNewlines(rawText);

      // ∆Øu ti√™n regex linh ho·∫°t cho m·ªëc ƒë·∫ßu ki·ªÉu "@ B·∫°n..."
      let startRegex;
      if (startMarker && startMarker.trim()) {
        // N·∫øu ƒë√∫ng m·ªëc m·∫∑c ƒë·ªãnh, cho ph√©p linh ho·∫°t kho·∫£ng tr·∫Øng sau @
        if (startMarker.trim().toLowerCase() === '@b·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng') {
          startRegex = /@\s*B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng/i;
        } else {
          startRegex = new RegExp(escapeRegExp(startMarker.trim()), 'i');
        }
      } else {
        startRegex = /@\s*B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng/i;
      }

      const startMatch = startRegex.exec(text);
      if (!startMatch) {
        return { ok:false, error:`Kh√¥ng t√¨m th·∫•y m·ªëc b·∫Øt ƒë·∫ßu: "${startMarker || '@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng'}"` };
      }

      const afterStart = text.slice(startMatch.index + startMatch[0].length);

      const endFound = findEndMatchByPriority(afterStart, endMarker, endMarkersPriority);
      if (!endFound) {
        const listText = (Array.isArray(endMarkersPriority) && endMarkersPriority.length)
          ? endMarkersPriority.join(' ‚Üí ')
          : (endMarker || 'Ch∆∞∆°ng tr∆∞·ªõc');
        return { ok:false, error:`Kh√¥ng t√¨m th·∫•y m·ªëc k·∫øt th√∫c theo th·ª© t·ª± ∆∞u ti√™n: "${listText}"` };
      }

      const endMatch = endFound.match;
      const endMarkerUsed = endFound.marker;
      let story = afterStart.slice(0, endMatch.index);

      story = story
        .replace(/^\s+/, '')
        .replace(/\s+$/, '')
        .replace(/\u200B/g, '')
        .replace(/\ufeff/g, '')
        .replace(/\n{3,}/g, '\n\n');

      if (!story.trim()) {
        return { ok:false, error:'ƒê√£ t√¨m th·∫•y m·ªëc nh∆∞ng n·ªôi dung gi·ªØa 2 m·ªëc r·ªóng.' };
      }

      return { ok:true, text:story, endMarkerUsed };
    }

    function getExtraRemovePhrases(){
      const raw = (els.extraRemovePhrases && els.extraRemovePhrases.value) ? els.extraRemovePhrases.value : '';
      return normalizeNewlines(raw)
        .split('\n')
        .map(s => s.trim())
        .filter(Boolean);
    }

    function applyCustomPhraseRemovals(text, phrases){
      let t = String(text || '');
      if (!Array.isArray(phrases) || !phrases.length) return t;

      for (const phrase of phrases){
        const p = String(phrase || '').trim();
        if (!p) continue;
        const rx = new RegExp(escapeRegExp(p), 'gi');
        t = t.replace(rx, '');
      }

      // D·ªçn l·∫°i kho·∫£ng tr·∫Øng sau khi x√≥a c·ª•m t·ª´
      t = t
        .replace(/[ \t]{2,}/g, ' ')
        .replace(/\n[ \t]+/g, '\n')
        .replace(/[ \t]+\n/g, '\n')
        .replace(/\n{3,}/g, '\n\n');

      return t;
    }

    function removeCommonNoise(text, extraPhrases = []){
      let t = normalizeNewlines(text);

      // X√≥a m·ªôt s·ªë d√≤ng r√°c ph·ªï bi·∫øn n·∫øu c√≤n l·ªçt v√†o
      const linePatterns = [
        /^\s*Truy·ªán ƒë∆∞·ª£c ƒëƒÉng t·∫°i\s*https?:\/\/\S+.*$/gim,
        /^\s*Trang ch·ªß\s+Th·∫ø gi·ªõi\s+T√¨m Truy·ªán.*$/gim,
        /^\s*C√°p bi·ªÉn APG.*$/gim,
        /^\s*Xem b√¨nh lu·∫≠n.*$/gim,
        /^\s*B√åNH LU·∫¨N\s*$/gim,
        /^\s*sangtacviet\.com.*$/gim,
        /^\s*\d+\s*Online\s*$/gim,
        /^\s*Ch∆∞∆°ng tr∆∞·ªõc\s*M·ª•c l·ª•c\s*Ch∆∞∆°ng sau\s*$/gim
      ];

      for (const p of linePatterns) t = t.replace(p, '');

      // X√≥a c·ª•m t·ª´ t√πy ch·ªânh (m·ªói d√≤ng 1 c·ª•m trong ph·∫ßn T√πy ch·ªânh m·ªëc)
      t = applyCustomPhraseRemovals(t, extraPhrases);

      t = t
        .replace(/[ \t]+\n/g, '\n')
        .replace(/\n{3,}/g, '\n\n')
        .trim();

      return t;
    }

    function oneClickCleanChapter(rawText){
      const start = els.startMarker.value || '@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng';
      const end = els.endMarker.value || 'Ch∆∞∆°ng tr∆∞·ªõc';
      const endPriority = getEndMarkerPriorityList();

      const ext = extractStoryContentRobust(rawText, start, end, endPriority);
      if (!ext.ok) return ext;

      let t = ext.text;
      const extraPhrases = getExtraRemovePhrases();
      t = removeCommonNoise(t, extraPhrases);

      return { ok:true, text:t };
    }

    function runExtract(){
      const start = els.startMarker.value || '@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng';
      const end = els.endMarker.value || 'Ch∆∞∆°ng tr∆∞·ªõc';
      const endPriority = getEndMarkerPriorityList();

      const res = extractStoryContentRobust(els.input.value, start, end, endPriority);
      if (!res.ok) {
        els.output.value = '';
        updateStats();
        setStatus('‚ùå ' + res.error, 'err');
        return;
      }

      els.output.value = res.text;
      updateStats();
      setStatus(`‚úÖ ƒê√£ l·∫•y ƒëo·∫°n truy·ªán th√†nh c√¥ng (m·ªëc d·ª´ng: <b>${res.endMarkerUsed || 'kh√¥ng r√µ'}</b>). <b>${res.text.length.toLocaleString('vi-VN')}</b> k√Ω t·ª±.`, 'ok');
    }

    function runOneClickClean(){
      const res = oneClickCleanChapter(els.input.value);
      if (!res.ok) {
        els.output.value = '';
        updateStats();
        setStatus('‚ùå ' + res.error, 'err');
        return;
      }

      els.output.value = res.text;
      updateStats();
      setStatus(`‚úÖ L√†m s·∫°ch 1 ch·∫°m th√†nh c√¥ng (m·ªëc d·ª´ng: <b>${res.endMarkerUsed || 'kh√¥ng r√µ'}</b>). <b>${res.text.length.toLocaleString('vi-VN')}</b> k√Ω t·ª±.`, 'ok');
    }

    async function copyOutput(){
      const text = els.output.value;
      if (!text) {
        setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ copy.', 'warn');
        return;
      }
      try{
        await navigator.clipboard.writeText(text);
        setStatus('‚úÖ ƒê√£ copy k·∫øt qu·∫£ v√†o clipboard.', 'ok');
      }catch(e){
        // Fallback
        els.output.select();
        document.execCommand('copy');
        setStatus('‚úÖ ƒê√£ copy k·∫øt qu·∫£ (fallback).', 'ok');
      }
    }

    function downloadTxt(){
      const text = els.output.value;
      if (!text) {
        setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ t·∫£i TXT.', 'warn');
        return;
      }
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const name = `chuong_sach_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.txt`;
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus('‚úÖ ƒê√£ t·∫£i file TXT k·∫øt qu·∫£.', 'ok');
    }

    async function pasteInput(){
      try{
        const txt = await navigator.clipboard.readText();
        if (!txt) {
          setStatus('‚ö†Ô∏è Clipboard kh√¥ng c√≥ vƒÉn b·∫£n.', 'warn');
          return;
        }
        els.input.value = txt;
        updateStats();
        setStatus('‚úÖ ƒê√£ d√°n vƒÉn b·∫£n t·ª´ clipboard.', 'ok');
      }catch(e){
        setStatus('‚ö†Ô∏è Tr√¨nh duy·ªát ch·∫∑n ƒë·ªçc clipboard. H√£y d√°n th·ªß c√¥ng v√†o √¥ b√™n tr√°i.', 'warn');
      }
    }

    function openTextFile(file){
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        els.input.value = String(e.target.result || '');
        updateStats();
        setStatus(`‚úÖ ƒê√£ m·ªü file: <b>${file.name}</b>`, 'ok');
      };
      reader.onerror = () => {
        setStatus('‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file TXT.', 'err');
      };
      reader.readAsText(file, 'utf-8');
    }

    // S·ª± ki·ªán n√∫t
    els.btnExtract.addEventListener('click', runExtract);
    els.btnOneClick.addEventListener('click', runOneClickClean);
    els.btnCopy.addEventListener('click', copyOutput);
    els.btnDownloadTxt.addEventListener('click', downloadTxt);

    els.btnSwap.addEventListener('click', () => {
      if (!els.output.value) {
        setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ ƒë∆∞a l√™n √¥ tr√™n.', 'warn');
        return;
      }
      els.input.value = els.output.value;
      els.output.value = '';
      updateStats();
      setStatus('‚úÖ ƒê√£ ƒë∆∞a k·∫øt qu·∫£ l√™n √¥ tr√™n (ƒë·ªÉ x·ª≠ l√Ω ti·∫øp).', 'ok');
    });

    els.btnClearAll.addEventListener('click', () => {
      els.input.value = '';
      els.output.value = '';
      updateStats();
      setStatus('üßπ ƒê√£ x√≥a to√†n b·ªô n·ªôi dung.', '');
    });

    els.btnPaste.addEventListener('click', pasteInput);

    els.btnTrimInput.addEventListener('click', () => {
      els.input.value = els.input.value.trim();
      updateStats();
      setStatus('‚úÖ ƒê√£ x√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi c·ªßa √¥ input.', 'ok');
    });

    els.btnNormalize.addEventListener('click', () => {
      els.input.value = normalizeNewlines(els.input.value);
      updateStats();
      setStatus('‚úÖ ƒê√£ chu·∫©n h√≥a xu·ªëng d√≤ng.', 'ok');
    });

    els.btnSelectOutput.addEventListener('click', () => {
      if (!els.output.value) {
        setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ ch·ªçn.', 'warn');
        return;
      }
      els.output.removeAttribute('readonly');
      els.output.focus();
      els.output.select();
      els.output.setAttribute('readonly', '');
      setStatus('‚úÖ ƒê√£ ch·ªçn to√†n b·ªô k·∫øt qu·∫£.', 'ok');
    });

    els.btnRemoveBlankLines.addEventListener('click', () => {
      if (!els.output.value) {
        setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω.', 'warn');
        return;
      }
      els.output.value = els.output.value.replace(/\n{3,}/g, '\n\n').trim();
      updateStats();
      setStatus('‚úÖ ƒê√£ g·ªôp d√≤ng tr·ªëng d∆∞ trong k·∫øt qu·∫£.', 'ok');
    });

    els.btnRemoveWatermark.addEventListener('click', () => {
      if (!els.output.value) {
        setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω.', 'warn');
        return;
      }
      const extraPhrases = getExtraRemovePhrases();
      els.output.value = removeCommonNoise(els.output.value, extraPhrases);
      updateStats();
      setStatus('‚úÖ ƒê√£ x√≥a watermark/d√≤ng r√°c ph·ªï bi·∫øn + c·ª•m t·ª´ t√πy ch·ªânh trong k·∫øt qu·∫£.', 'ok');
    });

    // File input
    els.fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (file) openTextFile(file);
      e.target.value = '';
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(evt => {
      els.dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        els.dropZone.classList.add('drag');
      });
    });

    ['dragleave','drop'].forEach(evt => {
      els.dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        els.dropZone.classList.remove('drag');
      });
    });

    els.dropZone.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!file) return;
      if (!/\.txt$/i.test(file.name) && file.type !== 'text/plain') {
        setStatus('‚ö†Ô∏è Vui l√≤ng th·∫£ file .txt', 'warn');
        return;
      }
      openTextFile(file);
    });

    // Ph√≠m t·∫Øt
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        runExtract();
      }
      if (e.ctrlKey && e.shiftKey && (e.key.toLowerCase() === 'l')) {
        e.preventDefault();
        runOneClickClean();
      }
    });

    // C·∫≠p nh·∫≠t th·ªëng k√™ realtime
    els.input.addEventListener('input', updateStats);
    els.output.addEventListener('input', updateStats);

    updateStats();
  </script>
</body>
</html>
