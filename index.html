<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tool c·∫Øt & l√†m s·∫°ch ch∆∞∆°ng truy·ªán - v4 (priority start/end)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2b; --panel2:#0f1728; --line:#23304a;
      --text:#e8eefc; --muted:#9fb0d4; --accent:#4ea1ff; --ok:#38d39f;
      --warn:#ffb84d; --err:#ff6b6b; --chip:#1b2740;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#09101d,#0c1424 35%, #0a1220);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
    .title{font-size:20px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}
    .stats{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px;border-bottom:1px solid var(--line);align-items:center}
    .btn{border:1px solid var(--line);background:#16213a;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px}
    .btn:hover{transform:translateY(-1px);border-color:#315089}
    .btn.primary{background:linear-gradient(180deg,#2f7be8,#235fba);border-color:#3b7fe0}
    .btn.success{background:linear-gradient(180deg,#1e7c62,#16624f);border-color:#279a7b}
    .btn.warn{background:linear-gradient(180deg,#8d6120,#6f4b16);border-color:#b37b28}
    .btn.ghost{background:transparent}
    .pill{margin-left:auto;color:var(--muted);font-size:12px;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;white-space:nowrap}
    input[type="file"]{display:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}.pill{margin-left:0}}
    .panel{display:flex;flex-direction:column;min-height:480px}
    .panel h3{margin:0;padding:12px 12px 0;font-size:14px}
    .hint{color:var(--muted);font-size:12px;padding:4px 12px 10px}
    textarea,input{width:100%;border:1px solid var(--line);background:#0b1322;color:var(--text);border-radius:12px;padding:12px;outline:none;font-size:14px}
    textarea:focus,input:focus{border-color:#3f76d7;box-shadow:0 0 0 3px rgba(78,161,255,.12)}
    textarea{line-height:1.55;resize:vertical}
    #inputText,#outputText{min-height:360px;margin:0 12px 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;padding:0 12px 12px}
    .row .btn{padding:8px 10px;font-size:13px}
    .drop{margin:0 12px 12px;border:1px dashed #34528b;border-radius:12px;padding:12px;text-align:center;color:var(--muted);background:rgba(78,161,255,.05);font-size:13px}
    .drop.drag{border-color:#67b4ff;background:rgba(78,161,255,.12);color:#d8ecff}
    .status{margin:0 12px 12px;border-radius:12px;padding:10px 12px;border:1px solid var(--line);background:#101a2d;color:var(--muted);font-size:13px;min-height:42px;display:flex;align-items:center}
    .status.ok{color:#b9ffe7;border-color:rgba(56,211,159,.35);background:rgba(56,211,159,.08)}
    .status.err{color:#ffd1d1;border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.08)}
    .status.warn{color:#ffe8c1;border-color:rgba(255,184,77,.35);background:rgba(255,184,77,.08)}
    details{margin:12px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0f1728}
    summary{cursor:pointer;padding:10px 12px;color:#dbe8ff;font-weight:600;user-select:none}
    .detailsBody{border-top:1px solid var(--line);padding:12px;display:grid;gap:10px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:920px){.two{grid-template-columns:1fr}}
    .small{font-size:12px;color:var(--muted)}
    .footer{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;color:var(--muted);font-size:12px;padding:10px 12px 14px;border-top:1px dashed var(--line)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .kbd{border:1px solid var(--line);padding:1px 6px;border-radius:6px;background:#0e1729;font-size:11px;color:#c9daff}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="title">Tool c·∫Øt & l√†m s·∫°ch ch∆∞∆°ng truy·ªán (v6)</div>
      <div class="subtitle">H·ªó tr·ª£ <b>m·ªëc b·∫Øt ƒë·∫ßu</b> v√† <b>m·ªëc k·∫øt th√∫c</b> theo <b>th·ª© t·ª± ∆∞u ti√™n</b> ‚Ä¢ m·ªói d√≤ng 1 m·ªëc ‚Ä¢ <b>t·ª± l∆∞u c√†i ƒë·∫∑t m·ªëc</b></div>
    </div>
    <div class="stats">
      <div class="chip" id="statInput">Input: 0 k√Ω t·ª±</div>
      <div class="chip" id="statOutput">Output: 0 k√Ω t·ª±</div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <button class="btn primary" id="btnExtract">L·∫•y ƒëo·∫°n truy·ªán</button>
      <button class="btn success" id="btnOneClick">L√†m s·∫°ch 1 ch·∫°m</button>
      <button class="btn" id="btnCopy">Copy k·∫øt qu·∫£</button>
      <button class="btn warn" id="btnDownloadTxt">T·∫£i TXT</button>
      <button class="btn ghost" id="btnSwap">ƒê∆∞a k·∫øt qu·∫£ l√™n √¥ tr√™n</button>
      <button class="btn ghost" id="btnClearAll">X√≥a t·∫•t c·∫£</button>
      <label class="btn" for="fileInput">M·ªü file .txt</label>
      <input id="fileInput" type="file" accept=".txt,text/plain">
      <span class="pill">M·∫πo: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> = L·∫•y ƒëo·∫°n ‚Ä¢ m·ªëc t·ª± l∆∞u</span>
    </div>

    <details>
      <summary>‚öôÔ∏è T√πy ch·ªânh m·ªëc c·∫Øt & c·ª•m t·ª´ x√≥a th√™m</summary>
      <div class="detailsBody">
        <div class="two">
          <div class="field">
            <label>M·ªëc b·∫Øt ƒë·∫ßu m·∫∑c ƒë·ªãnh (fallback n·∫øu danh s√°ch ∆∞u ti√™n kh√¥ng kh·ªõp)</label>
            <input id="startMarker" value="@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng">
          </div>
          <div class="field">
            <label>M·ªëc k·∫øt th√∫c m·∫∑c ƒë·ªãnh (fallback n·∫øu danh s√°ch ∆∞u ti√™n kh√¥ng kh·ªõp)</label>
            <input id="endMarker" value="Ch∆∞∆°ng tr∆∞·ªõc">
          </div>
        </div>

        <div class="two">
          <div class="field">
            <label>M·ªëc b·∫Øt ƒë·∫ßu theo th·ª© t·ª± ∆∞u ti√™n (m·ªói d√≤ng 1 m·ªëc)</label>
            <textarea id="startMarkersPriority" rows="6">@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng
@ B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng</textarea>
            <div class="small">Tool s·∫Ω x√©t t·ª´ tr√™n xu·ªëng: g·∫∑p m·ªëc n√†o tr∆∞·ªõc trong danh s√°ch th√¨ d√πng m·ªëc ƒë√≥.</div>
          </div>

          <div class="field">
            <label>M·ªëc k·∫øt th√∫c theo th·ª© t·ª± ∆∞u ti√™n (m·ªói d√≤ng 1 m·ªëc)</label>
            <textarea id="endMarkersPriority" rows="6">Ch∆∞∆°ng tr∆∞·ªõc
M·ª•c l·ª•c
Ch∆∞∆°ng sau</textarea>
            <div class="small">V√≠ d·ª•: c√≥ "Ch∆∞∆°ng tr∆∞·ªõc" th√¨ d·ª´ng ·ªü ƒë√≥; kh√¥ng c√≥ m·ªõi x√©t "M·ª•c l·ª•c"... </div>
          </div>
        </div>

        <div class="field">
          <div class="small">‚úÖ C√°c √¥ m·ªëc b·∫Øt ƒë·∫ßu / m·ªëc k·∫øt th√∫c / c·ª•m t·ª´ x√≥a th√™m s·∫Ω t·ª± l∆∞u tr√™n tr√¨nh duy·ªát (localStorage). T·∫£i l·∫°i trang v·∫´n c√≤n.</div>
          <label>C·ª•m t·ª´ x√≥a th√™m (m·ªói d√≤ng 1 c·ª•m, √°p d·ª•ng trong ‚ÄúL√†m s·∫°ch 1 ch·∫°m‚Äù v√† ‚ÄúX√≥a watermark ph·ªï bi·∫øn‚Äù)</label>
          <textarea id="extraRemovePhrases" rows="12">Ch∆∞∆°ng tr∆∞·ªõc
M·ª•c l·ª•c
Ch∆∞∆°ng sau
UUKANSHU ƒë·ªçc s√°ch www.uukanshu.com
www.uukanshu.com
UUKANSHU
uukanshu
‚Äî‚Äî
......
69 s√°ch a www.69shu.org
ƒë·ªïi m·ªõi nhanh nh·∫•t Ch∆∞∆°ng m·ªõi nh·∫•t!
( T·∫•u ch∆∞∆°ng xong )
.!)"</textarea>
        </div>
              <div class="row" style="padding:0">
          <button class="btn" type="button" id="btnSaveSettingsNow">L∆∞u c√†i ƒë·∫∑t m·ªëc ngay</button>
          <button class="btn ghost" type="button" id="btnResetSavedSettings">X√≥a c√†i ƒë·∫∑t m·ªëc ƒë√£ l∆∞u</button>
        </div>
      </div>
    </details>

    <div class="grid">
      <div class="panel">
        <h3>VƒÉn b·∫£n g·ªëc (d√°n v√†o ƒë√¢y)</h3>
        <div class="hint">D√°n to√†n b·ªô n·ªôi dung copy t·ª´ web. Tool s·∫Ω t·ª± c·∫Øt theo m·ªëc ∆∞u ti√™n b·∫°n nh·∫≠p.</div>
        <div class="drop" id="dropZone">K√©o th·∫£ file <b>.txt</b> v√†o ƒë√¢y (ho·∫∑c b·∫•m ‚ÄúM·ªü file .txt‚Äù)</div>
        <textarea id="inputText" placeholder="D√°n vƒÉn b·∫£n v√†o ƒë√¢y..."></textarea>
        <div class="row">
          <button class="btn" id="btnPaste">D√°n t·ª´ clipboard</button>
          <button class="btn" id="btnTrimInput">X√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi</button>
          <button class="btn" id="btnNormalize">Chu·∫©n h√≥a xu·ªëng d√≤ng</button>
        </div>
      </div>

      <div class="panel">
        <h3>K·∫øt qu·∫£ (ƒëo·∫°n truy·ªán ƒë√£ c·∫Øt)</h3>
        <div class="hint">K·∫øt qu·∫£ sau khi c·∫Øt (v√† l√†m s·∫°ch n·∫øu d√πng ‚ÄúL√†m s·∫°ch 1 ch·∫°m‚Äù).</div>
        <textarea id="outputText" placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y..." readonly></textarea>
        <div class="row">
          <button class="btn" id="btnSelectOutput">Ch·ªçn to√†n b·ªô k·∫øt qu·∫£</button>
          <button class="btn" id="btnRemoveBlankLines">G·ªôp d√≤ng tr·ªëng d∆∞</button>
          <button class="btn" id="btnRemoveWatermark">X√≥a watermark ph·ªï bi·∫øn</button>
        </div>
      </div>
    </div>

    <div id="status" class="status">S·∫µn s√†ng. D√°n vƒÉn b·∫£n v√†o √¥ b√™n tr√°i r·ªìi b·∫•m <b>L·∫•y ƒëo·∫°n truy·ªán</b> ho·∫∑c <b>L√†m s·∫°ch 1 ch·∫°m</b>.</div>

    <div class="footer">
      <div>‚úÖ Offline ‚Ä¢ ‚úÖ GitHub Pages ‚Ä¢ ‚úÖ ∆Øu ti√™n m·ªëc b·∫Øt ƒë·∫ßu/k·∫øt th√∫c theo th·ª© t·ª± ‚Ä¢ ‚úÖ T·ª± l∆∞u m·ªëc</div>
      <div class="mono">v6-localstorage-marker-settings</div>
    </div>
  </div>
</div>

<script>
const els = {
  input: document.getElementById('inputText'),
  output: document.getElementById('outputText'),
  status: document.getElementById('status'),
  statInput: document.getElementById('statInput'),
  statOutput: document.getElementById('statOutput'),
  startMarker: document.getElementById('startMarker'),
  endMarker: document.getElementById('endMarker'),
  startMarkersPriority: document.getElementById('startMarkersPriority'),
  endMarkersPriority: document.getElementById('endMarkersPriority'),
  extraRemovePhrases: document.getElementById('extraRemovePhrases'),
  fileInput: document.getElementById('fileInput'),
  dropZone: document.getElementById('dropZone'),
  btnExtract: document.getElementById('btnExtract'),
  btnOneClick: document.getElementById('btnOneClick'),
  btnCopy: document.getElementById('btnCopy'),
  btnDownloadTxt: document.getElementById('btnDownloadTxt'),
  btnSwap: document.getElementById('btnSwap'),
  btnClearAll: document.getElementById('btnClearAll'),
  btnPaste: document.getElementById('btnPaste'),
  btnTrimInput: document.getElementById('btnTrimInput'),
  btnNormalize: document.getElementById('btnNormalize'),
  btnSelectOutput: document.getElementById('btnSelectOutput'),
  btnRemoveBlankLines: document.getElementById('btnRemoveBlankLines'),
  btnRemoveWatermark: document.getElementById('btnRemoveWatermark'),
  btnSaveSettingsNow: document.getElementById('btnSaveSettingsNow'),
  btnResetSavedSettings: document.getElementById('btnResetSavedSettings')

};

// ===== localStorage: l∆∞u c√†i ƒë·∫∑t m·ªëc / c·ª•m t·ª´ x√≥a th√™m =====
const STORAGE_KEY = 'tool_cat_doan_truyen_settings_v6';

function getSettingsFields(){
  return ['startMarker','endMarker','startMarkersPriority','endMarkersPriority','extraRemovePhrases'];
}

function saveSettingsToLocal(){
  try{
    const data = {};
    for (const key of getSettingsFields()){
      if (els[key]) data[key] = els[key].value ?? '';
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(err){}
}

function loadSettingsFromLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const data = JSON.parse(raw);
    if (!data || typeof data !== 'object') return false;
    let restored = 0;
    for (const key of getSettingsFields()){
      if (els[key] && typeof data[key] === 'string'){
        els[key].value = data[key];
        restored++;
      }
    }
    return restored > 0;
  }catch(err){
    return false;
  }
}

function bindAutoSaveSettings(){
  for (const key of getSettingsFields()){
    if (!els[key]) continue;
    els[key].addEventListener('input', saveSettingsToLocal);
    els[key].addEventListener('change', saveSettingsToLocal);
  }
}

function resetSavedSettings(){
  try{
    localStorage.removeItem(STORAGE_KEY);
    setStatus('üóëÔ∏è ƒê√£ x√≥a c√†i ƒë·∫∑t m·ªëc ƒë√£ l∆∞u tr√™n tr√¨nh duy·ªát. T·∫£i l·∫°i trang ƒë·ªÉ v·ªÅ m·∫∑c ƒë·ªãnh.', 'ok');
  }catch(err){
    setStatus('‚ö†Ô∏è Kh√¥ng x√≥a ƒë∆∞·ª£c c√†i ƒë·∫∑t l∆∞u tr√™n tr√¨nh duy·ªát.', 'warn');
  }
}

function setStatus(msg, type=''){

  els.status.className = 'status' + (type ? ' ' + type : '');
  els.status.innerHTML = msg;
}
function normalizeNewlines(text){ return String(text || '').replace(/\r\n/g,'\n').replace(/\r/g,'\n'); }
function updateStats(){
  els.statInput.textContent = `Input: ${els.input.value.length.toLocaleString('vi-VN')} k√Ω t·ª±`;
  els.statOutput.textContent = `Output: ${els.output.value.length.toLocaleString('vi-VN')} k√Ω t·ª±`;
}
function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function parseLines(value){
  return normalizeNewlines(value).split('\n').map(s=>s.trim()).filter(Boolean);
}
function markerToRegex(marker){
  const m = String(marker || '').trim();
  if (!m) return null;
  const lower = m.toLowerCase();
  if (lower === '@b·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng' || lower === '@ b·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng'){
    return /@\s*B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng/i;
  }
  return new RegExp(escapeRegExp(m), 'i');
}
function findMarkerByPriority(text, markers, fallbackMarker, kind='start'){
  for (const marker of (markers || [])){
    const re = markerToRegex(marker);
    if (!re) continue;
    const match = re.exec(text);
    if (match){
      return { ok:true, markerText: marker, match, source:'priority' };
    }
  }
  if (fallbackMarker && String(fallbackMarker).trim()){
    const re = markerToRegex(String(fallbackMarker).trim());
    if (re){
      const match = re.exec(text);
      if (match){
        return { ok:true, markerText:String(fallbackMarker).trim(), match, source:'fallback' };
      }
    }
  }
  return { ok:false, error:`Kh√¥ng t√¨m th·∫•y m·ªëc ${kind === 'start' ? 'b·∫Øt ƒë·∫ßu' : 'k·∫øt th√∫c'}.` };
}
function extractStoryContentPriority(rawText){
  if (!rawText || typeof rawText !== 'string') return { ok:false, error:'Kh√¥ng c√≥ d·ªØ li·ªáu vƒÉn b·∫£n.' };
  const text = normalizeNewlines(rawText);

  const startRes = findMarkerByPriority(text, parseLines(els.startMarkersPriority.value), els.startMarker.value || '@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng', 'start');
  if (!startRes.ok) return { ok:false, error:startRes.error + ' (Ki·ªÉm tra danh s√°ch m·ªëc b·∫Øt ƒë·∫ßu.)' };

  const startIndex = startRes.match.index + startRes.match[0].length;
  const afterStart = text.slice(startIndex);

  const endRes = findMarkerByPriority(afterStart, parseLines(els.endMarkersPriority.value), els.endMarker.value || 'Ch∆∞∆°ng tr∆∞·ªõc', 'end');
  if (!endRes.ok) return { ok:false, error:endRes.error + ' (Ki·ªÉm tra danh s√°ch m·ªëc k·∫øt th√∫c.)' };

  let story = afterStart.slice(0, endRes.match.index)
    .replace(/^\s+/, '')
    .replace(/\s+$/, '')
    .replace(/\u200B/g, '')
    .replace(/\ufeff/g, '')
    .replace(/\n{3,}/g, '\n\n');

  if (!story.trim()) return { ok:false, error:'ƒê√£ t√¨m th·∫•y m·ªëc nh∆∞ng n·ªôi dung gi·ªØa 2 m·ªëc r·ªóng.' };

  return {
    ok:true, text:story,
    usedStart:startRes.markerText, usedStartSource:startRes.source,
    usedEnd:endRes.markerText, usedEndSource:endRes.source
  };
}
function removeExtraPhrases(text){
  let t = normalizeNewlines(text);
  for (const ph of parseLines(els.extraRemovePhrases.value)){
    t = t.replace(new RegExp(escapeRegExp(ph), 'gi'), '');
  }
  return t;
}
function removeCommonNoise(text){
  let t = normalizeNewlines(text);
  const patterns = [
    /^\s*Truy·ªán ƒë∆∞·ª£c ƒëƒÉng t·∫°i\s*https?:\/\/\S+.*$/gim,
    /^\s*Trang ch·ªß\s+Th·∫ø gi·ªõi\s+T√¨m Truy·ªán.*$/gim,
    /^\s*C√°p bi·ªÉn APG.*$/gim,
    /^\s*Xem b√¨nh lu·∫≠n.*$/gim,
    /^\s*B√åNH LU·∫¨N\s*$/gim,
    /^\s*sangtacviet\.com.*$/gim,
    /^\s*\d+\s*Online\s*$/gim,
    /^\s*Ch∆∞∆°ng tr∆∞·ªõc\s*M·ª•c l·ª•c\s*Ch∆∞∆°ng sau\s*$/gim
  ];
  for (const p of patterns) t = t.replace(p, '');
  t = removeExtraPhrases(t);
  return t.replace(/[ \t]+\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim();
}
function runExtract(){
  const res = extractStoryContentPriority(els.input.value);
  if (!res.ok){ els.output.value=''; updateStats(); setStatus('‚ùå ' + res.error, 'err'); return; }
  els.output.value = res.text; updateStats();
  setStatus(`‚úÖ ƒê√£ l·∫•y ƒëo·∫°n truy·ªán. Start: <b>${res.usedStart}</b> (${res.usedStartSource}) ‚Ä¢ End: <b>${res.usedEnd}</b> (${res.usedEndSource}) ‚Ä¢ <b>${res.text.length.toLocaleString('vi-VN')}</b> k√Ω t·ª±.`, 'ok');
}
function runOneClickClean(){
  const res = extractStoryContentPriority(els.input.value);
  if (!res.ok){ els.output.value=''; updateStats(); setStatus('‚ùå ' + res.error, 'err'); return; }
  els.output.value = removeCommonNoise(res.text); updateStats();
  setStatus(`‚úÖ L√†m s·∫°ch 1 ch·∫°m xong. Start: <b>${res.usedStart}</b> ‚Ä¢ End: <b>${res.usedEnd}</b> ‚Ä¢ <b>${els.output.value.length.toLocaleString('vi-VN')}</b> k√Ω t·ª±.`, 'ok');
}
async function copyOutput(){
  if (!els.output.value){ setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ copy.', 'warn'); return; }
  try{ await navigator.clipboard.writeText(els.output.value); setStatus('‚úÖ ƒê√£ copy k·∫øt qu·∫£.', 'ok'); }
  catch(e){
    try{
      els.output.removeAttribute('readonly'); els.output.focus(); els.output.select(); document.execCommand('copy'); els.output.setAttribute('readonly','');
      setStatus('‚úÖ ƒê√£ copy k·∫øt qu·∫£ (fallback).', 'ok');
    }catch{ setStatus('‚ö†Ô∏è Kh√¥ng copy ƒë∆∞·ª£c. H√£y copy th·ªß c√¥ng.', 'warn'); }
  }
}
function downloadTxt(){
  if (!els.output.value){ setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ t·∫£i TXT.', 'warn'); return; }
  const blob = new Blob([els.output.value], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const d = new Date(), pad=n=>String(n).padStart(2,'0');
  a.href = url;
  a.download = `chuong_sach_v4_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.txt`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  setStatus('‚úÖ ƒê√£ t·∫£i file TXT k·∫øt qu·∫£.', 'ok');
}
async function pasteInput(){
  try{
    const txt = await navigator.clipboard.readText();
    if (!txt){ setStatus('‚ö†Ô∏è Clipboard kh√¥ng c√≥ vƒÉn b·∫£n.', 'warn'); return; }
    els.input.value = txt; updateStats(); setStatus('‚úÖ ƒê√£ d√°n vƒÉn b·∫£n t·ª´ clipboard.', 'ok');
  }catch{ setStatus('‚ö†Ô∏è Tr√¨nh duy·ªát ch·∫∑n ƒë·ªçc clipboard. H√£y d√°n th·ªß c√¥ng.', 'warn'); }
}
function openTextFile(file){
  const reader = new FileReader();
  reader.onload = e => { els.input.value = String(e.target.result || ''); updateStats(); setStatus(`‚úÖ ƒê√£ m·ªü file: <b>${file.name}</b>`, 'ok'); };
  reader.onerror = () => setStatus('‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file TXT.', 'err');
  reader.readAsText(file, 'utf-8');
}

els.btnExtract.addEventListener('click', runExtract);
els.btnOneClick.addEventListener('click', runOneClickClean);
els.btnCopy.addEventListener('click', copyOutput);
els.btnDownloadTxt.addEventListener('click', downloadTxt);
els.btnSwap.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ ƒë∆∞a l√™n √¥ tr√™n.', 'warn');return;} els.input.value=els.output.value; els.output.value=''; updateStats(); setStatus('‚úÖ ƒê√£ ƒë∆∞a k·∫øt qu·∫£ l√™n √¥ tr√™n.', 'ok'); });
els.btnClearAll.addEventListener('click', ()=>{ els.input.value=''; els.output.value=''; updateStats(); setStatus('üßπ ƒê√£ x√≥a to√†n b·ªô n·ªôi dung.', ''); });
els.btnPaste.addEventListener('click', pasteInput);
els.btnTrimInput.addEventListener('click', ()=>{ els.input.value = els.input.value.trim(); updateStats(); setStatus('‚úÖ ƒê√£ x√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi input.', 'ok'); });
els.btnNormalize.addEventListener('click', ()=>{ els.input.value = normalizeNewlines(els.input.value); updateStats(); setStatus('‚úÖ ƒê√£ chu·∫©n h√≥a xu·ªëng d√≤ng.', 'ok'); });
els.btnSelectOutput.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ ch·ªçn.', 'warn');return;} els.output.removeAttribute('readonly'); els.output.focus(); els.output.select(); els.output.setAttribute('readonly',''); setStatus('‚úÖ ƒê√£ ch·ªçn to√†n b·ªô k·∫øt qu·∫£.', 'ok'); });
els.btnRemoveBlankLines.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω.', 'warn');return;} els.output.value = els.output.value.replace(/\n{3,}/g,'\n\n').trim(); updateStats(); setStatus('‚úÖ ƒê√£ g·ªôp d√≤ng tr·ªëng d∆∞.', 'ok'); });
els.btnRemoveWatermark.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω.', 'warn');return;} els.output.value = removeCommonNoise(els.output.value); updateStats(); setStatus('‚úÖ ƒê√£ x√≥a watermark ph·ªï bi·∫øn + c·ª•m t·ª´ x√≥a th√™m.', 'ok'); });

els.fileInput.addEventListener('change', e => { const file = e.target.files && e.target.files[0]; if(file) openTextFile(file); e.target.value=''; });
['dragenter','dragover'].forEach(evt => els.dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); els.dropZone.classList.add('drag'); }));
['dragleave','drop'].forEach(evt => els.dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); els.dropZone.classList.remove('drag'); }));
els.dropZone.addEventListener('drop', e => {
  const file = e.dataTransfer.files && e.dataTransfer.files[0];
  if (!file) return;
  if (!/\.txt$/i.test(file.name) && file.type !== 'text/plain'){ setStatus('‚ö†Ô∏è Vui l√≤ng th·∫£ file .txt', 'warn'); return; }
  openTextFile(file);
});

document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'Enter'){ e.preventDefault(); runExtract(); }
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l'){ e.preventDefault(); runOneClickClean(); }
});

els.input.addEventListener('input', updateStats);
els.output.addEventListener('input', updateStats);

// Kh√¥i ph·ª•c c√†i ƒë·∫∑t m·ªëc ƒë√£ l∆∞u (n·∫øu c√≥) + t·ª± ƒë·ªông l∆∞u khi ng∆∞·ªùi d√πng ch·ªânh
const __restoredSettings = loadSettingsFromLocal();
bindAutoSaveSettings();

if (els.btnSaveSettingsNow){
  els.btnSaveSettingsNow.addEventListener('click', () => {
    saveSettingsToLocal();
    setStatus('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t m·ªëc/c·ª•m t·ª´ v√†o tr√¨nh duy·ªát.', 'ok');
  });
}
if (els.btnResetSavedSettings){
  els.btnResetSavedSettings.addEventListener('click', resetSavedSettings);
}

updateStats();
if (__restoredSettings){
  setStatus('‚úÖ ƒê√£ kh√¥i ph·ª•c c√†i ƒë·∫∑t m·ªëc ƒë√£ l∆∞u t·ª´ l·∫ßn tr∆∞·ªõc.', 'ok');
}
</script>
</body>
</html>
