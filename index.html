<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tool c·∫Øt & l√†m s·∫°ch ch∆∞∆°ng truy·ªán - v4 (priority start/end)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2b; --panel2:#0f1728; --line:#23304a;
      --text:#e8eefc; --muted:#9fb0d4; --accent:#4ea1ff; --ok:#38d39f;
      --warn:#ffb84d; --err:#ff6b6b; --chip:#1b2740;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#09101d,#0c1424 35%, #0a1220);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
    .title{font-size:20px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}
    .stats{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:4px 8px;border-radius:999px;font-size:12px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px;border-bottom:1px solid var(--line);align-items:center}
    .btn{border:1px solid var(--line);background:#16213a;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600;font-size:14px}
    .btn:hover{transform:translateY(-1px);border-color:#315089}
    .btn.primary{background:linear-gradient(180deg,#2f7be8,#235fba);border-color:#3b7fe0}
    .btn.success{background:linear-gradient(180deg,#1e7c62,#16624f);border-color:#279a7b}
    .btn.warn{background:linear-gradient(180deg,#8d6120,#6f4b16);border-color:#b37b28}
    .btn.ghost{background:transparent}
    .toolbar .mini-input{
      width:220px; max-width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:#0f1728; color:var(--text);
      font-size:13px;
    }
    .toolbar .mini-input::placeholder{color:var(--muted)}
    .pill{margin-left:auto;color:var(--muted);font-size:12px;background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;white-space:nowrap}
    input[type="file"]{display:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}.pill{margin-left:0}}
    .panel{display:flex;flex-direction:column;min-height:480px}
    .panel h3{margin:0;padding:12px 12px 0;font-size:14px}
    .hint{color:var(--muted);font-size:12px;padding:4px 12px 10px}
    textarea,input{width:100%;border:1px solid var(--line);background:#0b1322;color:var(--text);border-radius:12px;padding:12px;outline:none;font-size:14px}
    textarea:focus,input:focus{border-color:#3f76d7;box-shadow:0 0 0 3px rgba(78,161,255,.12)}
    textarea{line-height:1.55;resize:vertical}
    #inputText,#outputText{min-height:360px;margin:0 12px 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;padding:0 12px 12px}
    .row .btn{padding:8px 10px;font-size:13px}
    .drop{margin:0 12px 12px;border:1px dashed #34528b;border-radius:12px;padding:12px;text-align:center;color:var(--muted);background:rgba(78,161,255,.05);font-size:13px}
    .drop.drag{border-color:#67b4ff;background:rgba(78,161,255,.12);color:#d8ecff}
    .status{margin:0 12px 12px;border-radius:12px;padding:10px 12px;border:1px solid var(--line);background:#101a2d;color:var(--muted);font-size:13px;min-height:42px;display:flex;align-items:center}
    .status.ok{color:#b9ffe7;border-color:rgba(56,211,159,.35);background:rgba(56,211,159,.08)}
    .status.err{color:#ffd1d1;border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.08)}
    .status.warn{color:#ffe8c1;border-color:rgba(255,184,77,.35);background:rgba(255,184,77,.08)}
    details{margin:12px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0f1728}
    summary{cursor:pointer;padding:10px 12px;color:#dbe8ff;font-weight:600;user-select:none}
    .detailsBody{border-top:1px solid var(--line);padding:12px;display:grid;gap:10px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:920px){.two{grid-template-columns:1fr}}
    .small{font-size:12px;color:var(--muted)}
    .footer{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;color:var(--muted);font-size:12px;padding:10px 12px 14px;border-top:1px dashed var(--line)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .kbd{border:1px solid var(--line);padding:1px 6px;border-radius:6px;background:#0e1729;font-size:11px;color:#c9daff}
    .appbar{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:10px;
      margin-bottom:10px; padding:10px 12px;
      border:1px solid var(--line); border-radius:14px;
      background:rgba(11,18,32,.88); backdrop-filter: blur(8px);
      box-shadow:0 8px 22px rgba(0,0,0,.2);
    }
    .appbar .appbar-title{font-weight:700}
    .appbar .appbar-sub{font-size:12px;color:var(--muted)}
    .hamburger{
      width:42px;height:42px;border-radius:12px;border:1px solid var(--line);
      background:#16213a;color:var(--text);cursor:pointer;
      display:grid;place-items:center;font-size:20px;line-height:1;
      flex:0 0 auto;
    }
    .hamburger:hover{border-color:#3b6dc4;transform:translateY(-1px)}
    .drawer-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:80;
    }
    .drawer-backdrop.show{opacity:1; pointer-events:auto}
    .drawer-panel{
      position:fixed; top:0; left:0; height:100vh; width:min(94vw,460px);
      transform:translateX(-100%); transition:transform .24s ease;
      z-index:90; display:flex; flex-direction:column;
      background:linear-gradient(180deg,#0f1728,#0b1220);
      border-right:1px solid var(--line); box-shadow:14px 0 32px rgba(0,0,0,.35);
    }
    .drawer-panel.show{transform:translateX(0)}
    .drawer-head{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:12px; border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.01);
    }
    .drawer-title{font-size:15px;font-weight:700}
    .drawer-close{
      width:36px;height:36px;border-radius:10px;border:1px solid var(--line);
      background:#16213a;color:var(--text);cursor:pointer;
    }
    .drawer-body{padding:12px; overflow:auto; display:grid; gap:12px}
    .drawer-card{
      border:1px solid var(--line); border-radius:14px; background:#10192c;
      padding:10px;
    }
    .drawer-card h4{margin:0 0 8px;font-size:14px}
    .drawer-actions{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px}
    .drawer-list{
      border:1px solid var(--line); border-radius:10px; background:#0b1322;
      padding:8px; max-height:120px; overflow:auto; font-size:12px; color:var(--muted);
    }
    .drawer-list .item{padding:4px 2px; border-bottom:1px dashed rgba(255,255,255,.07)}
    .drawer-list .item:last-child{border-bottom:none}
    .drawer-txt{
      min-height:180px; resize:vertical; width:100%;
      border:1px solid var(--line); border-radius:12px; background:#0b1322; color:var(--text);
      padding:10px; line-height:1.5;
    }
    .drawer-note{font-size:12px; color:var(--muted)}

  </style>
</head>
<body>
<div class="drawer-backdrop" id="drawerBackdrop"></div>
<aside class="drawer-panel" id="drawerPanel" aria-hidden="true">
  <div class="drawer-head">
    <div>
      <div class="drawer-title">‚ò∞ Kh√¥ng gian TXT</div>
      <div class="drawer-note">Ch·ªçn nhi·ªÅu t·ªáp TXT, g·ªôp l√†m 1 v√† copy lu√¥n</div>
    </div>
    <button class="drawer-close" id="btnCloseDrawer" type="button" aria-label="ƒê√≥ng">‚úï</button>
  </div>
  <div class="drawer-body">
    <div class="drawer-card">
      <h4>üìÇ Ch·ªçn TXT (nhi·ªÅu t·ªáp c√πng l√∫c)</h4>
      <div class="drawer-actions">
        <label class="btn" for="multiTxtFileInput">Ch·ªçn nhi·ªÅu TXT</label>
        <input id="multiTxtFileInput" type="file" accept=".txt,text/plain" multiple style="display:none">
        <button class="btn" id="btnCopyPanelTxt" type="button">Copy √¥ TXT</button>
        <button class="btn ghost" id="btnSendPanelToInput" type="button">ƒê∆∞a v√†o √¥ vƒÉn b·∫£n g·ªëc</button>
        <button class="btn ghost" id="btnClearPanelTxt" type="button">X√≥a √¥ TXT</button>
      </div>
      <div class="drawer-note">Tool s·∫Ω gi·ªØ ƒë√∫ng th·ª© t·ª± t·ªáp theo danh s√°ch tr·∫£ v·ªÅ t·ª´ tr√¨nh ch·ªçn file (th∆∞·ªùng l√† th·ª© t·ª± b·∫°n ch·ªçn).</div>
      <div class="drawer-list" id="multiTxtFileList">Ch∆∞a ch·ªçn t·ªáp TXT n√†o.</div>
    </div>

    <div class="drawer-card">
      <h4>üìù √î vƒÉn b·∫£n TXT (g·ªôp ƒë·ªÉ copy)</h4>
      <textarea id="multiTxtTextarea" class="drawer-txt" placeholder="Sau khi ch·ªçn nhi·ªÅu file TXT, n·ªôi dung g·ªôp s·∫Ω hi·ªán ·ªü ƒë√¢y ƒë·ªÉ b·∫°n copy 1 l·∫ßn..."></textarea>
      <div class="drawer-note" id="multiTxtMeta">T·ªïng: 0 t·ªáp ‚Ä¢ 0 k√Ω t·ª±</div>
    </div>
  </div>
</aside>

<div class="wrap">
  <div class="appbar">
    <button class="hamburger" id="btnOpenDrawer" type="button" aria-label="M·ªü kh√¥ng gian TXT">‚ò∞</button>
    <div>
      <div class="appbar-title">Menu nhanh TXT</div>
      <div class="appbar-sub">B·∫•m 3 g·∫°ch ngang ƒë·ªÉ v√†o kh√¥ng gian ri√™ng (m·ªü nhi·ªÅu TXT + copy 1 l·∫ßn)</div>
    </div>
  </div>
  <div class="header">
    <div>
      <div class="title">Tool c·∫Øt & l√†m s·∫°ch ch∆∞∆°ng truy·ªán (v11.1)</div>
      <div class="subtitle">H·ªó tr·ª£ <b>m·ªëc b·∫Øt ƒë·∫ßu</b> v√† <b>m·ªëc k·∫øt th√∫c</b> theo <b>th·ª© t·ª± ∆∞u ti√™n</b> ‚Ä¢ m·ªói d√≤ng 1 m·ªëc ‚Ä¢ <b>t·ª± l∆∞u c√†i ƒë·∫∑t m·ªëc</b> ‚Ä¢ <b>t·ª± nh·ªõ t√™n file TXT</b> ‚Ä¢ <b>t·ª± tƒÉng s·ªë t√™n file</b></div>
    </div>
    <div class="stats">
      <div class="chip" id="statInput">Input: 0 k√Ω t·ª±</div>
      <div class="chip" id="statOutput">Output: 0 k√Ω t·ª±</div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <button class="btn primary" id="btnExtract">L·∫•y ƒëo·∫°n truy·ªán</button>
      <button class="btn success" id="btnOneClick">L√†m s·∫°ch 1 ch·∫°m</button>
      <button class="btn" id="btnCopy">Copy k·∫øt qu·∫£</button>
      <button class="btn warn" id="btnDownloadTxt">T·∫£i TXT</button>
      <input id="txtFileName" class="mini-input" type="text" placeholder="T√™n file TXT (t·ª± nh·ªõ)">
      <label class="chip" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
        <input id="autoIncrementName" type="checkbox" checked style="width:auto;margin:0">
        T·ª± tƒÉng s·ªë
      </label>
      <button class="btn ghost" id="btnResetNameCounter" type="button">Reset s·ªë</button>
      <button class="btn ghost" id="btnSwap">ƒê∆∞a k·∫øt qu·∫£ l√™n √¥ tr√™n</button>
      <button class="btn ghost" id="btnClearAll">X√≥a t·∫•t c·∫£</button>
      <label class="btn" for="fileInput">M·ªü file .txt</label>
      <input id="fileInput" type="file" accept=".txt,text/plain">
      <span class="pill">M·∫πo: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> = L·∫•y ƒëo·∫°n ‚Ä¢ 3 g·∫°ch ngang m·ªü kh√¥ng gian TXT ‚Ä¢ m·ªëc/t√™n file/b·ªô ƒë·∫øm t·ª± l∆∞u</span>
    </div>

    <details>
      <summary>‚öôÔ∏è T√πy ch·ªânh m·ªëc c·∫Øt & c·ª•m t·ª´ x√≥a th√™m</summary>
      <div class="detailsBody">
        <div class="two">
          <div class="field">
            <label>M·ªëc b·∫Øt ƒë·∫ßu m·∫∑c ƒë·ªãnh (fallback n·∫øu danh s√°ch ∆∞u ti√™n kh√¥ng kh·ªõp)</label>
            <input id="startMarker" value="@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng">
          </div>
          <div class="field">
            <label>M·ªëc k·∫øt th√∫c m·∫∑c ƒë·ªãnh (fallback n·∫øu danh s√°ch ∆∞u ti√™n kh√¥ng kh·ªõp)</label>
            <input id="endMarker" value="Ch∆∞∆°ng tr∆∞·ªõc">
          </div>
        </div>

        <div class="two">
          <div class="field">
            <label>M·ªëc b·∫Øt ƒë·∫ßu theo th·ª© t·ª± ∆∞u ti√™n (m·ªói d√≤ng 1 m·ªëc)</label>
            <textarea id="startMarkersPriority" rows="6">@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng
@ B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng</textarea>
            <div class="small">Tool s·∫Ω x√©t t·ª´ tr√™n xu·ªëng: g·∫∑p m·ªëc n√†o tr∆∞·ªõc trong danh s√°ch th√¨ d√πng m·ªëc ƒë√≥.</div>
          </div>

          <div class="field">
            <label>M·ªëc k·∫øt th√∫c theo th·ª© t·ª± ∆∞u ti√™n (m·ªói d√≤ng 1 m·ªëc)</label>
            <textarea id="endMarkersPriority" rows="6">Ch∆∞∆°ng tr∆∞·ªõc
M·ª•c l·ª•c
Ch∆∞∆°ng sau</textarea>
            <div class="small">V√≠ d·ª•: c√≥ "Ch∆∞∆°ng tr∆∞·ªõc" th√¨ d·ª´ng ·ªü ƒë√≥; kh√¥ng c√≥ m·ªõi x√©t "M·ª•c l·ª•c"... </div>
          </div>
        </div>

        <div class="field">
          <div class="small">‚úÖ C√°c √¥ m·ªëc b·∫Øt ƒë·∫ßu / m·ªëc k·∫øt th√∫c / c·ª•m t·ª´ x√≥a th√™m / t√™n file TXT / b·∫≠t-t·∫Øt t·ª± tƒÉng s·ªë s·∫Ω t·ª± l∆∞u tr√™n tr√¨nh duy·ªát (localStorage). T·∫£i l·∫°i trang v·∫´n c√≤n.</div>
          <label>C·ª•m t·ª´ x√≥a th√™m (m·ªói d√≤ng 1 c·ª•m, √°p d·ª•ng trong ‚ÄúL√†m s·∫°ch 1 ch·∫°m‚Äù v√† ‚ÄúX√≥a watermark ph·ªï bi·∫øn‚Äù)</label>
          <textarea id="extraRemovePhrases" rows="12">Ch∆∞∆°ng tr∆∞·ªõc
M·ª•c l·ª•c
Ch∆∞∆°ng sau
UUKANSHU ƒë·ªçc s√°ch www.uukanshu.com
www.uukanshu.com
UUKANSHU
uukanshu
‚Äî‚Äî
......
69 s√°ch a www.69shu.org
ƒë·ªïi m·ªõi nhanh nh·∫•t Ch∆∞∆°ng m·ªõi nh·∫•t!
( T·∫•u ch∆∞∆°ng xong )
.!)"</textarea>
        </div>
              <div class="row" style="padding:0">
          <button class="btn" type="button" id="btnSaveSettingsNow">L∆∞u c√†i ƒë·∫∑t m·ªëc ngay</button>
          <button class="btn ghost" type="button" id="btnResetSavedSettings">X√≥a c√†i ƒë·∫∑t m·ªëc ƒë√£ l∆∞u</button>
        </div>
      </div>
    </details>

    <div class="grid">
      <div class="panel">
        <h3>VƒÉn b·∫£n g·ªëc (d√°n v√†o ƒë√¢y)</h3>
        <div class="hint">D√°n to√†n b·ªô n·ªôi dung copy t·ª´ web. Tool s·∫Ω t·ª± c·∫Øt theo m·ªëc ∆∞u ti√™n b·∫°n nh·∫≠p.</div>
        <div class="drop" id="dropZone">K√©o th·∫£ file <b>.txt</b> v√†o ƒë√¢y (ho·∫∑c b·∫•m ‚ÄúM·ªü file .txt‚Äù)</div>
        <textarea id="inputText" placeholder="D√°n vƒÉn b·∫£n v√†o ƒë√¢y..."></textarea>
        <div class="row">
          <button class="btn" id="btnPaste">D√°n t·ª´ clipboard</button>
          <button class="btn" id="btnTrimInput">X√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi</button>
          <button class="btn" id="btnNormalize">Chu·∫©n h√≥a xu·ªëng d√≤ng</button>
        </div>
      </div>

      <div class="panel">
        <h3>K·∫øt qu·∫£ (ƒëo·∫°n truy·ªán ƒë√£ c·∫Øt)</h3>
        <div class="hint">K·∫øt qu·∫£ sau khi c·∫Øt (v√† l√†m s·∫°ch n·∫øu d√πng ‚ÄúL√†m s·∫°ch 1 ch·∫°m‚Äù).</div>
        <textarea id="outputText" placeholder="K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y..." readonly></textarea>
        <div class="row">
          <button class="btn" id="btnSelectOutput">Ch·ªçn to√†n b·ªô k·∫øt qu·∫£</button>
          <button class="btn" id="btnRemoveBlankLines">G·ªôp d√≤ng tr·ªëng d∆∞</button>
          <button class="btn" id="btnRemoveWatermark">X√≥a watermark ph·ªï bi·∫øn</button>
        </div>
      </div>
    </div>

    <div id="status" class="status">S·∫µn s√†ng. D√°n vƒÉn b·∫£n v√†o √¥ b√™n tr√°i r·ªìi b·∫•m <b>L·∫•y ƒëo·∫°n truy·ªán</b> ho·∫∑c <b>L√†m s·∫°ch 1 ch·∫°m</b>.</div>

    <div class="footer">
      <div>‚úÖ Offline ‚Ä¢ ‚úÖ GitHub Pages ‚Ä¢ ‚úÖ 3 g·∫°ch ngang/panel ri√™ng ‚Ä¢ ‚úÖ M·ªü nhi·ªÅu TXT c√πng l√∫c ‚Ä¢ ‚úÖ Copy xong t·ª± x√≥a panel TXT ‚Ä¢ ‚úÖ T·ª± x√≥a sau khi t·∫£i</div>
      <div class="mono">v11.1-copy-clear-panel</div>
    </div>
  </div>
</div>

<script>
const els = {
  input: document.getElementById('inputText'),
  output: document.getElementById('outputText'),
  status: document.getElementById('status'),
  statInput: document.getElementById('statInput'),
  statOutput: document.getElementById('statOutput'),
  startMarker: document.getElementById('startMarker'),
  endMarker: document.getElementById('endMarker'),
  startMarkersPriority: document.getElementById('startMarkersPriority'),
  endMarkersPriority: document.getElementById('endMarkersPriority'),
  extraRemovePhrases: document.getElementById('extraRemovePhrases'),
  fileInput: document.getElementById('fileInput'),
  dropZone: document.getElementById('dropZone'),
  btnExtract: document.getElementById('btnExtract'),
  btnOneClick: document.getElementById('btnOneClick'),
  btnCopy: document.getElementById('btnCopy'),
  btnDownloadTxt: document.getElementById('btnDownloadTxt'),
  btnSwap: document.getElementById('btnSwap'),
  btnClearAll: document.getElementById('btnClearAll'),
  btnPaste: document.getElementById('btnPaste'),
  btnTrimInput: document.getElementById('btnTrimInput'),
  btnNormalize: document.getElementById('btnNormalize'),
  btnSelectOutput: document.getElementById('btnSelectOutput'),
  btnRemoveBlankLines: document.getElementById('btnRemoveBlankLines'),
  btnRemoveWatermark: document.getElementById('btnRemoveWatermark'),
  btnSaveSettingsNow: document.getElementById('btnSaveSettingsNow'),
  btnResetSavedSettings: document.getElementById('btnResetSavedSettings'),
  txtFileName: document.getElementById('txtFileName'),
  autoIncrementName: document.getElementById('autoIncrementName'),
  btnResetNameCounter: document.getElementById('btnResetNameCounter')

};

// ===== refs: panel 3 g·∫°ch / multi TXT (v11) =====
Object.assign(els, {
  btnOpenDrawer: document.getElementById('btnOpenDrawer'),
  btnCloseDrawer: document.getElementById('btnCloseDrawer'),
  drawerPanel: document.getElementById('drawerPanel'),
  drawerBackdrop: document.getElementById('drawerBackdrop'),
  multiTxtFileInput: document.getElementById('multiTxtFileInput'),
  multiTxtFileList: document.getElementById('multiTxtFileList'),
  multiTxtTextarea: document.getElementById('multiTxtTextarea'),
  multiTxtMeta: document.getElementById('multiTxtMeta'),
  btnCopyPanelTxt: document.getElementById('btnCopyPanelTxt'),
  btnSendPanelToInput: document.getElementById('btnSendPanelToInput'),
  btnClearPanelTxt: document.getElementById('btnClearPanelTxt')
});

// ===== localStorage: l∆∞u c√†i ƒë·∫∑t m·ªëc / c·ª•m t·ª´ x√≥a th√™m =====
const STORAGE_KEY = 'tool_cat_doan_truyen_settings_v8';
const FILE_COUNTER_MAP_KEY = 'tool_cat_doan_truyen_filename_counters_v8';

function getSettingsFields(){
  return ['startMarker','endMarker','startMarkersPriority','endMarkersPriority','extraRemovePhrases','txtFileName','autoIncrementName'];
}

function saveSettingsToLocal(){
  try{
    const data = {};
    for (const key of getSettingsFields()){
      if (!els[key]) continue;
      const el = els[key];
      if (el.type === 'checkbox') data[key] = !!el.checked;
      else data[key] = el.value ?? '';
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(err){}
}

function loadSettingsFromLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const data = JSON.parse(raw);
    if (!data || typeof data !== 'object') return false;
    let restored = 0;
    for (const key of getSettingsFields()){
      if (!els[key] || !(key in data)) continue;
      const el = els[key];
      if (el.type === 'checkbox') {
        el.checked = !!data[key];
      } else if (typeof data[key] === 'string') {
        el.value = data[key];
      } else {
        continue;
      }
      restored++;
    }
    return restored > 0;
  }catch(err){
    return false;
  }
}

function bindAutoSaveSettings(){
  for (const key of getSettingsFields()){
    if (!els[key]) continue;
    els[key].addEventListener('input', saveSettingsToLocal);
    els[key].addEventListener('change', saveSettingsToLocal);
  }
}

function loadFileCounterMap(){
  try{
    const raw = localStorage.getItem(FILE_COUNTER_MAP_KEY);
    const data = raw ? JSON.parse(raw) : {};
    return (data && typeof data === 'object') ? data : {};
  }catch(err){
    return {};
  }
}

function saveFileCounterMap(map){
  try{
    localStorage.setItem(FILE_COUNTER_MAP_KEY, JSON.stringify(map || {}));
  }catch(err){}
}

function splitFileNameParts(fileName){
  const m = String(fileName || '').match(/^(.*?)(\.[^.]+)?$/);
  return {
    stem: (m && m[1]) ? m[1] : 'chuong_sach',
    ext: (m && m[2]) ? m[2] : '.txt'
  };
}

// T·ª± tƒÉng: truyenchu.txt -> truyenchu1.txt -> truyenchu2.txt...
function getAutoIncrementFileName(fileName){
  const p = splitFileNameParts(fileName);
  // N·∫øu √¥ t√™n file ƒëang l√† truyenchu12.txt th√¨ coi "truyenchu" l√† g·ªëc ƒë·ªÉ tƒÉng ti·∫øp
  let baseStem = p.stem.replace(/\d+$/,'').trim();
  if (!baseStem) baseStem = p.stem || 'chuong_sach';

  const key = (baseStem + p.ext).toLowerCase();
  const map = loadFileCounterMap();
  const next = (Number(map[key]) || 0) + 1;
  map[key] = next;
  saveFileCounterMap(map);

  return {
    fileName: `${baseStem}${next}${p.ext}`,
    baseStem,
    ext: p.ext,
    count: next,
    key
  };
}

function resetCurrentFileCounter(){
  try{
    const rawName = (els.txtFileName && els.txtFileName.value) ? els.txtFileName.value : getDefaultTxtFileName();
    const cleanName = sanitizeFileName(rawName);
    const p = splitFileNameParts(cleanName);
    let baseStem = p.stem.replace(/\d+$/,'').trim();
    if (!baseStem) baseStem = p.stem || 'chuong_sach';
    const key = (baseStem + p.ext).toLowerCase();

    const map = loadFileCounterMap();
    delete map[key];
    saveFileCounterMap(map);

    if (els.txtFileName){
      els.txtFileName.value = `${baseStem}${p.ext}`;
      try { saveSettingsToLocal(); } catch(e) {}
    }
    setStatus(`‚úÖ ƒê√£ reset s·ªë t·ª± tƒÉng cho t√™n g·ªëc: <b>${baseStem}${p.ext}</b>`, 'ok');
  }catch(err){
    setStatus('‚ö†Ô∏è Kh√¥ng reset ƒë∆∞·ª£c s·ªë t·ª± tƒÉng.', 'warn');
  }
}

function resetSavedSettings(){
  try{
    localStorage.removeItem(STORAGE_KEY);
    setStatus('üóëÔ∏è ƒê√£ x√≥a c√†i ƒë·∫∑t m·ªëc/t√™n file ƒë√£ l∆∞u tr√™n tr√¨nh duy·ªát. (B·ªô ƒë·∫øm s·ªë file v·∫´n gi·ªØ, d√πng n√∫t Reset s·ªë ƒë·ªÉ reset ri√™ng.)', 'ok');
  }catch(err){
    setStatus('‚ö†Ô∏è Kh√¥ng x√≥a ƒë∆∞·ª£c c√†i ƒë·∫∑t l∆∞u tr√™n tr√¨nh duy·ªát.', 'warn');
  }
}

function setStatus(msg, type=''){

  els.status.className = 'status' + (type ? ' ' + type : '');
  els.status.innerHTML = msg;
}
function normalizeNewlines(text){ return String(text || '').replace(/\r\n/g,'\n').replace(/\r/g,'\n'); }
function updateStats(){
  els.statInput.textContent = `Input: ${els.input.value.length.toLocaleString('vi-VN')} k√Ω t·ª±`;
  els.statOutput.textContent = `Output: ${els.output.value.length.toLocaleString('vi-VN')} k√Ω t·ª±`;
}
function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function parseLines(value){
  return normalizeNewlines(value).split('\n').map(s=>s.trim()).filter(Boolean);
}
function markerToRegex(marker){
  const m = String(marker || '').trim();
  if (!m) return null;
  const lower = m.toLowerCase();
  if (lower === '@b·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng' || lower === '@ b·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng'){
    return /@\s*B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng/i;
  }
  return new RegExp(escapeRegExp(m), 'i');
}
function findMarkerByPriority(text, markers, fallbackMarker, kind='start'){
  for (const marker of (markers || [])){
    const re = markerToRegex(marker);
    if (!re) continue;
    const match = re.exec(text);
    if (match){
      return { ok:true, markerText: marker, match, source:'priority' };
    }
  }
  if (fallbackMarker && String(fallbackMarker).trim()){
    const re = markerToRegex(String(fallbackMarker).trim());
    if (re){
      const match = re.exec(text);
      if (match){
        return { ok:true, markerText:String(fallbackMarker).trim(), match, source:'fallback' };
      }
    }
  }
  return { ok:false, error:`Kh√¥ng t√¨m th·∫•y m·ªëc ${kind === 'start' ? 'b·∫Øt ƒë·∫ßu' : 'k·∫øt th√∫c'}.` };
}
function extractStoryContentPriority(rawText){
  if (!rawText || typeof rawText !== 'string') return { ok:false, error:'Kh√¥ng c√≥ d·ªØ li·ªáu vƒÉn b·∫£n.' };
  const text = normalizeNewlines(rawText);

  const startRes = findMarkerByPriority(text, parseLines(els.startMarkersPriority.value), els.startMarker.value || '@B·∫°n ƒëang ƒë·ªçc b·∫£n l∆∞u trong h·ªá th·ªëng', 'start');
  if (!startRes.ok) return { ok:false, error:startRes.error + ' (Ki·ªÉm tra danh s√°ch m·ªëc b·∫Øt ƒë·∫ßu.)' };

  const startIndex = startRes.match.index + startRes.match[0].length;
  const afterStart = text.slice(startIndex);

  const endRes = findMarkerByPriority(afterStart, parseLines(els.endMarkersPriority.value), els.endMarker.value || 'Ch∆∞∆°ng tr∆∞·ªõc', 'end');
  if (!endRes.ok) return { ok:false, error:endRes.error + ' (Ki·ªÉm tra danh s√°ch m·ªëc k·∫øt th√∫c.)' };

  let story = afterStart.slice(0, endRes.match.index)
    .replace(/^\s+/, '')
    .replace(/\s+$/, '')
    .replace(/\u200B/g, '')
    .replace(/\ufeff/g, '')
    .replace(/\n{3,}/g, '\n\n');

  if (!story.trim()) return { ok:false, error:'ƒê√£ t√¨m th·∫•y m·ªëc nh∆∞ng n·ªôi dung gi·ªØa 2 m·ªëc r·ªóng.' };

  return {
    ok:true, text:story,
    usedStart:startRes.markerText, usedStartSource:startRes.source,
    usedEnd:endRes.markerText, usedEndSource:endRes.source
  };
}
function removeExtraPhrases(text){
  let t = normalizeNewlines(text);
  for (const ph of parseLines(els.extraRemovePhrases.value)){
    t = t.replace(new RegExp(escapeRegExp(ph), 'gi'), '');
  }
  return t;
}
function removeCommonNoise(text){
  let t = normalizeNewlines(text);
  const patterns = [
    /^\s*Truy·ªán ƒë∆∞·ª£c ƒëƒÉng t·∫°i\s*https?:\/\/\S+.*$/gim,
    /^\s*Trang ch·ªß\s+Th·∫ø gi·ªõi\s+T√¨m Truy·ªán.*$/gim,
    /^\s*C√°p bi·ªÉn APG.*$/gim,
    /^\s*Xem b√¨nh lu·∫≠n.*$/gim,
    /^\s*B√åNH LU·∫¨N\s*$/gim,
    /^\s*sangtacviet\.com.*$/gim,
    /^\s*\d+\s*Online\s*$/gim,
    /^\s*Ch∆∞∆°ng tr∆∞·ªõc\s*M·ª•c l·ª•c\s*Ch∆∞∆°ng sau\s*$/gim
  ];
  for (const p of patterns) t = t.replace(p, '');
  t = removeExtraPhrases(t);
  return t.replace(/[ \t]+\n/g,'\n').replace(/\n{3,}/g,'\n\n').trim();
}
function runExtract(){
  const res = extractStoryContentPriority(els.input.value);
  if (!res.ok){ els.output.value=''; updateStats(); setStatus('‚ùå ' + res.error, 'err'); return; }
  els.output.value = res.text; updateStats();
  setStatus(`‚úÖ ƒê√£ l·∫•y ƒëo·∫°n truy·ªán. Start: <b>${res.usedStart}</b> (${res.usedStartSource}) ‚Ä¢ End: <b>${res.usedEnd}</b> (${res.usedEndSource}) ‚Ä¢ <b>${res.text.length.toLocaleString('vi-VN')}</b> k√Ω t·ª±.`, 'ok');
}
function runOneClickClean(){
  const res = extractStoryContentPriority(els.input.value);
  if (!res.ok){ els.output.value=''; updateStats(); setStatus('‚ùå ' + res.error, 'err'); return; }
  els.output.value = removeCommonNoise(res.text); updateStats();
  setStatus(`‚úÖ L√†m s·∫°ch 1 ch·∫°m xong. Start: <b>${res.usedStart}</b> ‚Ä¢ End: <b>${res.usedEnd}</b> ‚Ä¢ <b>${els.output.value.length.toLocaleString('vi-VN')}</b> k√Ω t·ª±.`, 'ok');
}
async function copyOutput(){
  if (!els.output.value){ setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ copy.', 'warn'); return; }
  try{ await navigator.clipboard.writeText(els.output.value); setStatus('‚úÖ ƒê√£ copy k·∫øt qu·∫£.', 'ok'); }
  catch(e){
    try{
      els.output.removeAttribute('readonly'); els.output.focus(); els.output.select(); document.execCommand('copy'); els.output.setAttribute('readonly','');
      setStatus('‚úÖ ƒê√£ copy k·∫øt qu·∫£ (fallback).', 'ok');
    }catch{ setStatus('‚ö†Ô∏è Kh√¥ng copy ƒë∆∞·ª£c. H√£y copy th·ªß c√¥ng.', 'warn'); }
  }
}
function getDefaultTxtFileName(){
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `chuong_sach_v7_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.txt`;
}

function sanitizeFileName(name){
  let n = String(name || '').trim();
  n = n.replace(/[\\/:*?"<>|]/g, '_'); // k√Ω t·ª± kh√¥ng h·ª£p l·ªá
  n = n.replace(/\s+/g, ' ').trim();
  if (!n) n = getDefaultTxtFileName();
  if (!/\.txt$/i.test(n)) n += '.txt';
  return n;
}

function downloadTxt(){
  if (!els.output.value){
    setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ t·∫£i TXT.', 'warn');
    return;
  }

  const rawName = (els.txtFileName && els.txtFileName.value) ? els.txtFileName.value : '';
  const cleanedBaseName = sanitizeFileName(rawName || getDefaultTxtFileName());

  let fileName = cleanedBaseName;
  let autoInfo = null;

  if (els.autoIncrementName && els.autoIncrementName.checked){
    autoInfo = getAutoIncrementFileName(cleanedBaseName);
    fileName = autoInfo.fileName;
  }

  if (els.txtFileName){
    // Hi·ªÉn th·ªã t√™n v·ª´a t·∫£i (l·∫ßn sau v·∫´n tƒÉng ti·∫øp nh·ªù b·ªô ƒë·∫øm localStorage)
    els.txtFileName.value = fileName;
    try { saveSettingsToLocal(); } catch(e) {}
  }

  const blob = new Blob([els.output.value], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  // T·ª± x√≥a n·ªôi dung sau khi t·∫£i xong (gi·ªØ l·∫°i c√†i ƒë·∫∑t m·ªëc / t√™n file / b·ªô ƒë·∫øm)
  els.input.value = '';
  els.output.value = '';
  updateStats();

  if (autoInfo){
    setStatus(`‚úÖ ƒê√£ t·∫£i file TXT: <b>${fileName}</b> ‚Ä¢ T·ª± tƒÉng s·ªë: <b>${autoInfo.count}</b> ‚Ä¢ ƒê√£ t·ª± x√≥a n·ªôi dung`, 'ok');
  } else {
    setStatus(`‚úÖ ƒê√£ t·∫£i file TXT: <b>${fileName}</b> ‚Ä¢ ƒê√£ t·ª± x√≥a n·ªôi dung`, 'ok');
  }
}
async function pasteInput(){
  try{
    const txt = await navigator.clipboard.readText();
    if (!txt){ setStatus('‚ö†Ô∏è Clipboard kh√¥ng c√≥ vƒÉn b·∫£n.', 'warn'); return; }
    els.input.value = txt; updateStats(); setStatus('‚úÖ ƒê√£ d√°n vƒÉn b·∫£n t·ª´ clipboard.', 'ok');
  }catch{ setStatus('‚ö†Ô∏è Tr√¨nh duy·ªát ch·∫∑n ƒë·ªçc clipboard. H√£y d√°n th·ªß c√¥ng.', 'warn'); }
}

// ===== Panel 3 g·∫°ch: m·ªü nhi·ªÅu TXT + √¥ vƒÉn b·∫£n TXT =====
let __multiTxtPickedFiles = [];

function openDrawerPanel(){
  if (!els.drawerPanel || !els.drawerBackdrop) return;
  els.drawerPanel.classList.add('show');
  els.drawerBackdrop.classList.add('show');
  els.drawerPanel.setAttribute('aria-hidden', 'false');
}
function closeDrawerPanel(){
  if (!els.drawerPanel || !els.drawerBackdrop) return;
  els.drawerPanel.classList.remove('show');
  els.drawerBackdrop.classList.remove('show');
  els.drawerPanel.setAttribute('aria-hidden', 'true');
}
function updateMultiTxtMeta(){
  const txt = String((els.multiTxtTextarea && els.multiTxtTextarea.value) || '');
  const fileCount = __multiTxtPickedFiles.length;
  if (els.multiTxtMeta){
    els.multiTxtMeta.textContent = `T·ªïng: ${fileCount} t·ªáp ‚Ä¢ ${txt.length.toLocaleString('vi-VN')} k√Ω t·ª±`;
  }
}
function renderMultiTxtFileList(){
  if (!els.multiTxtFileList) return;
  if (!__multiTxtPickedFiles.length){
    els.multiTxtFileList.innerHTML = 'Ch∆∞a ch·ªçn t·ªáp TXT n√†o.';
    updateMultiTxtMeta();
    return;
  }
  els.multiTxtFileList.innerHTML = __multiTxtPickedFiles.map((f, idx) => {
    const size = Number(f.size || 0).toLocaleString('vi-VN');
    return `<div class="item">${idx+1}. <b>${f.name}</b> ‚Ä¢ ${size} byte</div>`;
  }).join('');
  updateMultiTxtMeta();
}
function readTxtFileAsText(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(String(e.target.result || ''));
    reader.onerror = () => reject(new Error('read_error'));
    reader.readAsText(file, 'utf-8');
  });
}
async function handleMultiTxtSelect(fileList){
  const files = Array.from(fileList || []);
  if (!files.length){
    setStatus('‚ö†Ô∏è B·∫°n ch∆∞a ch·ªçn t·ªáp TXT n√†o.', 'warn');
    return;
  }
  const txtFiles = files.filter(f => /\.txt$/i.test(f.name) || f.type === 'text/plain' || !f.type);
  if (!txtFiles.length){
    setStatus('‚ö†Ô∏è Kh√¥ng c√≥ t·ªáp TXT h·ª£p l·ªá.', 'warn');
    return;
  }

  __multiTxtPickedFiles = txtFiles.slice();
  renderMultiTxtFileList();

  const chunks = [];
  let okCount = 0;
  for (const file of txtFiles){
    try{
      const content = await readTxtFileAsText(file);
      chunks.push(normalizeNewlines(content).trim());
      okCount++;
    }catch(err){
      chunks.push('');
    }
  }

  // G·ªôp th√†nh 1 ƒë·ªÉ copy lu√¥n (kh√¥ng th√™m ti√™u ƒë·ªÅ ph√¢n c√°ch ƒë·ªÉ vƒÉn b·∫£n s·∫°ch h∆°n)
  const merged = chunks.filter(Boolean).join('\n\n').trim();
  if (els.multiTxtTextarea){
    els.multiTxtTextarea.value = merged;
    updateMultiTxtMeta();
  }

  openDrawerPanel();
  setStatus(`‚úÖ ƒê√£ m·ªü ${okCount}/${txtFiles.length} t·ªáp TXT v√†o kh√¥ng gian ri√™ng (√¥ vƒÉn b·∫£n TXT).`, 'ok');
}
async function copyPanelTxt(){
  const txt = String((els.multiTxtTextarea && els.multiTxtTextarea.value) || '');
  if (!txt){
    setStatus('‚ö†Ô∏è √î vƒÉn b·∫£n TXT ƒëang tr·ªëng.', 'warn');
    return;
  }

  // Copy th√†nh c√¥ng -> t·ª± x√≥a panel TXT (danh s√°ch t·ªáp + √¥ vƒÉn b·∫£n)
  try{
    await navigator.clipboard.writeText(txt);
    clearPanelTxt();
    setStatus('‚úÖ ƒê√£ copy n·ªôi dung trong √¥ vƒÉn b·∫£n TXT v√† t·ª± x√≥a ph·∫ßn ch·ªçn t·ªáp TXT.', 'ok');
    return;
  }catch(err){}

  // Fallback copy th·ªß c√¥ng
  try{
    els.multiTxtTextarea.focus();
    els.multiTxtTextarea.select();
    document.execCommand('copy');
    clearPanelTxt();
    setStatus('‚úÖ ƒê√£ copy n·ªôi dung trong √¥ vƒÉn b·∫£n TXT (fallback) v√† t·ª± x√≥a ph·∫ßn ch·ªçn t·ªáp TXT.', 'ok');
  }catch(e2){
    setStatus('‚ö†Ô∏è Kh√¥ng copy ƒë∆∞·ª£c. H√£y copy th·ªß c√¥ng trong √¥ vƒÉn b·∫£n TXT.', 'warn');
  }
}
function sendPanelTxtToInput(){
  const txt = String((els.multiTxtTextarea && els.multiTxtTextarea.value) || '');
  if (!txt){
    setStatus('‚ö†Ô∏è √î vƒÉn b·∫£n TXT ƒëang tr·ªëng.', 'warn');
    return;
  }
  els.input.value = txt;
  updateStats();
  closeDrawerPanel();
  setStatus('‚úÖ ƒê√£ ƒë∆∞a n·ªôi dung t·ª´ √¥ vƒÉn b·∫£n TXT v√†o √¥ vƒÉn b·∫£n g·ªëc.', 'ok');
}
function clearPanelTxt(){
  __multiTxtPickedFiles = [];
  if (els.multiTxtTextarea) els.multiTxtTextarea.value = '';
  renderMultiTxtFileList();
  setStatus('üßπ ƒê√£ x√≥a danh s√°ch t·ªáp v√† √¥ vƒÉn b·∫£n TXT trong kh√¥ng gian ri√™ng.', 'ok');
}

function openTextFile(file){
  const reader = new FileReader();
  reader.onload = e => { els.input.value = String(e.target.result || ''); updateStats(); setStatus(`‚úÖ ƒê√£ m·ªü file: <b>${file.name}</b>`, 'ok'); };
  reader.onerror = () => setStatus('‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file TXT.', 'err');
  reader.readAsText(file, 'utf-8');
}

els.btnExtract.addEventListener('click', runExtract);
els.btnOneClick.addEventListener('click', runOneClickClean);
els.btnCopy.addEventListener('click', copyOutput);
els.btnDownloadTxt.addEventListener('click', downloadTxt);
els.btnSwap.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ ƒë∆∞a l√™n √¥ tr√™n.', 'warn');return;} els.input.value=els.output.value; els.output.value=''; updateStats(); setStatus('‚úÖ ƒê√£ ƒë∆∞a k·∫øt qu·∫£ l√™n √¥ tr√™n.', 'ok'); });
els.btnClearAll.addEventListener('click', ()=>{ els.input.value=''; els.output.value=''; updateStats(); setStatus('üßπ ƒê√£ x√≥a to√†n b·ªô n·ªôi dung.', ''); });
els.btnPaste.addEventListener('click', pasteInput);
els.btnTrimInput.addEventListener('click', ()=>{ els.input.value = els.input.value.trim(); updateStats(); setStatus('‚úÖ ƒê√£ x√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi input.', 'ok'); });
els.btnNormalize.addEventListener('click', ()=>{ els.input.value = normalizeNewlines(els.input.value); updateStats(); setStatus('‚úÖ ƒê√£ chu·∫©n h√≥a xu·ªëng d√≤ng.', 'ok'); });
els.btnSelectOutput.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ ch·ªçn.', 'warn');return;} els.output.removeAttribute('readonly'); els.output.focus(); els.output.select(); els.output.setAttribute('readonly',''); setStatus('‚úÖ ƒê√£ ch·ªçn to√†n b·ªô k·∫øt qu·∫£.', 'ok'); });
els.btnRemoveBlankLines.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω.', 'warn');return;} els.output.value = els.output.value.replace(/\n{3,}/g,'\n\n').trim(); updateStats(); setStatus('‚úÖ ƒê√£ g·ªôp d√≤ng tr·ªëng d∆∞.', 'ok'); });
els.btnRemoveWatermark.addEventListener('click', ()=>{ if(!els.output.value){setStatus('‚ö†Ô∏è Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ x·ª≠ l√Ω.', 'warn');return;} els.output.value = removeCommonNoise(els.output.value); updateStats(); setStatus('‚úÖ ƒê√£ x√≥a watermark ph·ªï bi·∫øn + c·ª•m t·ª´ x√≥a th√™m.', 'ok'); });

els.fileInput.addEventListener('change', e => { const file = e.target.files && e.target.files[0]; if(file) openTextFile(file); e.target.value=''; });
['dragenter','dragover'].forEach(evt => els.dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); els.dropZone.classList.add('drag'); }));
['dragleave','drop'].forEach(evt => els.dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); els.dropZone.classList.remove('drag'); }));
els.dropZone.addEventListener('drop', e => {
  const file = e.dataTransfer.files && e.dataTransfer.files[0];
  if (!file) return;
  if (!/\.txt$/i.test(file.name) && file.type !== 'text/plain'){ setStatus('‚ö†Ô∏è Vui l√≤ng th·∫£ file .txt', 'warn'); return; }
  openTextFile(file);
});

if (els.btnOpenDrawer) els.btnOpenDrawer.addEventListener('click', openDrawerPanel);
if (els.btnCloseDrawer) els.btnCloseDrawer.addEventListener('click', closeDrawerPanel);
if (els.drawerBackdrop) els.drawerBackdrop.addEventListener('click', closeDrawerPanel);

if (els.multiTxtFileInput){
  els.multiTxtFileInput.addEventListener('change', async (e) => {
    await handleMultiTxtSelect(e.target.files);
    e.target.value = '';
  });
}
if (els.btnCopyPanelTxt) els.btnCopyPanelTxt.addEventListener('click', copyPanelTxt);
if (els.btnSendPanelToInput) els.btnSendPanelToInput.addEventListener('click', sendPanelTxtToInput);
if (els.btnClearPanelTxt) els.btnClearPanelTxt.addEventListener('click', clearPanelTxt);
if (els.multiTxtTextarea) els.multiTxtTextarea.addEventListener('input', updateMultiTxtMeta);

document.addEventListener('keydown', e => {
  if (e.key === 'Escape'){ closeDrawerPanel(); }
  if (e.ctrlKey && e.key === 'Enter'){ e.preventDefault(); runExtract(); }
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l'){ e.preventDefault(); runOneClickClean(); }
});

els.input.addEventListener('input', updateStats);
els.output.addEventListener('input', updateStats);

// Kh√¥i ph·ª•c c√†i ƒë·∫∑t m·ªëc ƒë√£ l∆∞u (n·∫øu c√≥) + t·ª± ƒë·ªông l∆∞u khi ng∆∞·ªùi d√πng ch·ªânh
const __restoredSettings = loadSettingsFromLocal();
bindAutoSaveSettings();

if (els.btnSaveSettingsNow){
  els.btnSaveSettingsNow.addEventListener('click', () => {
    saveSettingsToLocal();
    setStatus('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t m·ªëc/c·ª•m t·ª´ v√†o tr√¨nh duy·ªát.', 'ok');
  });
}
if (els.btnResetSavedSettings){
  els.btnResetSavedSettings.addEventListener('click', resetSavedSettings);
}
if (els.btnResetNameCounter){
  els.btnResetNameCounter.addEventListener('click', resetCurrentFileCounter);
}

updateStats();
if (els.txtFileName && !String(els.txtFileName.value || '').trim()){
  els.txtFileName.value = 'truyenchu.txt';
  try { saveSettingsToLocal(); } catch(e) {}
}

if (__restoredSettings){
  setStatus('‚úÖ ƒê√£ kh√¥i ph·ª•c c√†i ƒë·∫∑t m·ªëc/t√™n file/t·ª± tƒÉng s·ªë ƒë√£ l∆∞u t·ª´ l·∫ßn tr∆∞·ªõc.', 'ok');
}
</script>
</body>
</html>
